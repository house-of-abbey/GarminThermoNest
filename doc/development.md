# Development Notes

* User and Rate [Limits in Sandbox](https://developers.google.com/nest/device-access/project/limits)

## Testing

Testing is limited to our single installed device on a single owner account and one watch. The installation is heating only, no air conditioning or cooling. Therefore:

* The simulator is the only way of judging functionality and appearance on other devices.
* Random data from a mock API has been used to verify the view layout of other modes (cooling, heat & cooling).
* Temperature setting has been limited to heating only.
* Only a single installation has been authenticated.
* No experience of multiple distinct owners retrieving their own (and no one else's) thermostat settings.

Help is sought for testing the following:

* Temperature setting in HVAC `COOL` mode.
* Temperature setting in HVAC `HEATCOOL` mode.
* Watches that are not `venu2`.
* Additional thermostat owners willing to test the application and verify privacy.

## Applying for Commercial Development

### Device Access

* [Product Review Guidelines](https://developers.google.com/nest/device-access/project/review)

_"After completing a Sandbox integration, if you would like to create a Commercial integration, you need to apply for Commercial Development by submitting a use case for review and approval. Upon approval, partners go through a certification process."_

### Compliance Matrix

So I wonder if Google Device Access has considered how appropriate their review guidelines are for a watch application. I suggest a watch application lives in a world where the primary function of the watch is to tell the time. Telling anything else brings us to the point of this application. It is not an "always on" application, but a "fleeting glance" one. You fire the application up, make the changes required and then revert to telling the time or tracking an activity.

This changes the requirements against which I think Google should review applications:

* Does not need to be up to date within seconds.
* Does not need to track changes to structures and rooms since it will just be a fleeting check. Changes will be picked up next time.
* Could benefit from a "refresh" button instead of polling the API continuously (and exceeding the 5 queries per minute limits imposed for thermostats in the sandbox for testing). In fact a refresh button can then be disabled for a few seconds to prevent refreshing too often and exhausting the query budget!
* The PubSub mechanism is available. It was slightly painful to set up, and avoids the sandbox limits. Its a good candidate replacement but how does monkey C perform a streaming pull? It could perform a one object at a time pull and then post the `AckId`, and loop forever. Is that really necessary for this application? Just glance perform an action and return to the watch face.

I also wonder how any reviewer will manage to perform the review at all. Will they have the right device for the application? Will they just review the source code in a potentially unfamiliar Monkey C language.

#### 1. Functionality

The following is our personal assessment of compliance with Google's product review guidelines.

| ID   | Requirement                                                                                                                                                                                                                                                                                                                                                                        | Compliant | Comment |
|-----:|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------:|---------|
| 1.1  | Products that do not use the official SDM API will be rejected.                                                                                                                                                                                                                                                                                                                    | Yes       |         |
| 1.2  | Products that crash will be rejected.                                                                                                                                                                                                                                                                                                                                              | Yes       |         |
| 1.3  | Products that exhibit user-visible bugs with significant functional impact will be rejected.                                                                                                                                                                                                                                                                                       | Yes       |         |
| 1.4  | Products that do not provide users with clear error messaging when actions fail, describing the reason for failure, will be rejected.                                                                                                                                                                                                                                              | Yes       | As a minimum the API error is printed to the watch screen via an ErrorView class. |
| 1.5  | Products that do not provide error and rate limit handling, will be rejected.                                                                                                                                                                                                                                                                                                      | Yes       | Managed via a manual refresh button, that contravenes another review point! |
| 1.6  | Products that do not work with the official SDM API, as described by the developer will be rejected.                                                                                                                                                                                                                                                                               | Yes       |         |
| 1.7  | Products that include undocumented or hidden features inconsistent with the description of the product or the permissions requested will be rejected.                                                                                                                                                                                                                              | Yes       |         |
| 1.8  | Products that are "demo," "trial," or "test" versions will be rejected. Beta apps will be considered. Products that support multiple platforms (for example, iOS, Android, and a website) should submit all supported platforms at the time of review. Products that do not submit all supported platforms for review may be rejected.                                             | Yes       | Garmin IQ only |
| 1.9  | Products that are not useful or unique or do not provide any lasting value, such as providing a more complete view of a user's home or added functionality apart from what Google Device Access provides, may be rejected.                                                                                                                                                         | Yes       |         |
| 1.10 | Products that are primarily marketing materials or advertisements with no additional value to users will be rejected.                                                                                                                                                                                                                                                              | Yes       | No marketing |
| 1.11 | Products that provide incorrect or other inaccurate device data will be rejected.                                                                                                                                                                                                                                                                                                  | Yes       |         |
| 1.12 | Products that do not pass Google Device Access Product review after multiple attempts may be rejected, removed from the Device Access program if the product was previously approved, and may be prohibited from making future submissions.                                                                                                                                        | We'll see |         |
| 1.13 | Products that collect, aggregate, re-syndicate, retain, log, or store (by any medium or mechanism) Customer Data received from the SDM API beyond 10 trailing days from the date when the data is received and stored will be rejected.                                                                                                                                            | Yes       | Absolutely no data retention, everything is done through the watch so we can't ever see user data |
| 1.14 | Products that collect, aggregate, re-syndicate, retain, log or store any audio recordings, video footage, or audio or video livestreams received via the SDM API ("Audio Visual Data") will be rejected. Any use of Audio Visual Data is strictly limited to the display of such data through your product.                                                                        | Yes       |         |
| 1.15 | Products that share Customer Data with third parties without consent from Google will be rejected.                                                                                                                                                                                                                                                                                 | Yes       |         |
| 1.16 | Products that allow simultaneous control of Google Nest devices across multiple Google accounts may be rejected.                                                                                                                                                                                                                                                                   | Yes       |         |
| 1.17 | Products that perform demand response or other energy management programs will be rejected.                                                                                                                                                                                                                                                                                        | Yes       |         |
| 1.18 | Products that purport to enable connected Google Nest devices, a customer's Google account, or collected Customer Data to provide interruption-free emergency response, notification services, life-safety, or other critical use services will be rejected.                                                                                                                       | Yes       |         |
| 1.19 | Products that evaluate users or their property individually or in aggregate for insurance or other financial products and services will be rejected.                                                                                                                                                                                                                               | Yes       |         |
| 1.20 | Products that breach the terms and conditions governing the use of any Google product or service will be rejected.                                                                                                                                                                                                                                                                 | Yes       |         |
| 1.21 | Products that call the SDM API without an initial direct and explicit end-user directed request will be rejected.                                                                                                                                                                                                                                                                  | Yes       |         |
| 1.22 | Products that record, collect, use, or store any information or data from a query or result, including without limitation any audio data, or metadata related to any queries, received as a result of an end user's use of, or authentication with, the Google Assistant, if the product or the services used are integrated with or distribute Google Assistant will be rejected. | Yes       |         |

#### 2. Branding and User Interface

| ID   | Requirement                                                                                                                                                                                  | Compliant | Comment |
|-----:|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------:|---------|
| 2.1  | All marketing materials must be submitted and receive approval via the Google Partner Marketing Hub prior to launch.                                                                         | Yes       | https://apps.garmin.com/ application page won't be live until *after* approval. Looks like that won't happen. |
| 2.2  | Products, whose actual product name, contains Google, Google Nest, Nest, Google Device Access, or any name that is confusingly similar to these Google trademarks, may be rejected.          | No        | How are we supposed to advertise the product controls Nest thermostats? |
| 2.3  | Products that contain UI elements that copy or closely resemble those in the Google Nest or Google Home app will be rejected.                                                                | No        | Orange & blue backgrounds are used to indicate operation in a similar way to the Nest |
| 2.4  | Products containing unapproved icons and images that copy or closely resemble those in Google Nest or Google Home app or Google Nest devices may be rejected.                                | Yes       |         |
| 2.5  | Products containing unapproved Google or Google Nest icons and images may be rejected.                                                                                                       | Yes       |         |
| 2.6  | Products that use Google or Google Nest icons to represent a Google structure, or use the Google G to represent UI elements other than a Google account or Google structure may be rejected. | Yes       |         |
| 2.7  | Products must not use Google Nest Blue (HEX #00AFD8) for UI elements other than approved Google Nest icons and images.                                                                       | Yes       | We don't but really, that's your hex colour now is it? What about +/- 1 in the RGB? |
| 2.8  | Products that use altered Google icons or Google device icons in ways that do not adhere to the Google Brand Permissions may be rejected.                                                    | Yes       |         |
| 2.9  | Products that advertise Google Nest integration and use case functionality that is not accurate or makes claims which cannot be substantiated will be rejected.                              | Yes       |         |
| 2.10 | Products that do not follow the guidelines for use of the phrases Device Access, Works with Google Assistant, and/or Google Smart Home will be rejected.                                     | Yes       | Then we won't use them! Where are these published? You don't provide a link in your review material. |
| 2.11 | Products that use a URL that incorporates any Google name (including, but not limited to Google or Nest) may be rejected.                                                                    | Yes       |         |
| 2.12 | Google Nest reserves the right to reject any marketing materials even if the prohibitions are not mentioned in this section.                                                                 | Yes       |         |

#### 3. Metadata

|  ID | Requirement                                                                                                                                                             | Compliant | Comment |
|----:|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------:|---------|
| 3.1 | Products with placeholder text, in name, description, or any other value will be rejected.                                                                              | Yes       |         |
| 3.2 | Products with names and descriptions not relevant to the functionality of the product will be rejected.                                                                 | Yes       |         |
| 3.3 | Products which access traits not relevant to the functionality of the product will be rejected.                                                                         | Yes       |         |
| 3.4 | Products with names, product literature, or promotional materials that are misleading, confusing, or incorporate third party trademarks or copyrights will be rejected. | Yes       | So we're back to whether the word "Nest" is even allowed to be used. |
| 3.5 | Products that recommend that users disable any Google product functionality may be rejected.                                                                            | Yes       |         |
| 3.6 | Products that do not have a valid working Support URL will be rejected.                                                                                                 | Yes       | [GitHub Support URL](https://house-of-abbey.github.io/GarminThermoNest/doc/), [Garmin IQ Application URL](https://apps.garmin.com/) pending some (limited) form of release. |
| 3.7 | Products that appear to copy UI elements from other apps may be rejected.                                                                                               | Yes       | [The pane indicator](index.md#navigation) has been deliberately copied from other Garmin IQ applications in order to retain the Garmin IQ App look and feel. |

#### 4. Authorisation

|   ID | Requirement                                                                                                                                                                                                                                                                                                                                       | Compliant | Comment |
|-----:|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------:|---------|
|  4.1 | Products that do not have correctly implemented authentication and authorization to a Google account may be rejected.                                                                                                                                                                                                                             | Yes       | [Google OAuth utterly stuffed the Garmin IQ SDK](index.md#open-authentication-oauth-for-smart-device-management-api) with their security update refusing to work with certain browsers and causing the first part of the authentication to only be possible outside of the application! We understand the reasons for Google's decision, but are not in a position to fix the SDK and have to live with a declared work around. |
|  4.2 | Use of the SDM API is restricted to countries where Google devices are sold.                                                                                                                                                                                                                                                                      | Yes as impossible to fail! | That is Google's decision and developers are unable to influence it, so automatic pass for everyone surely? This requirement should not even be in this list. |
|  4.3 | Products that do not securely store and transmit access tokens, authorization codes, and client secrets will be rejected.                                                                                                                                                                                                                         | Not yet   | Move tokens from settings to storage now we no longer require visibility for debug. |
|  4.4 | Products that include the ability to log out or disconnect from Google must use Google OAuth token revocation API to do so or direct the user to https://nestservices.google.com/partnerconnections. Products that do not handle this revoked authorization by reverting to a disconnected state and removing all Customer Data will be rejected. | Yes       | No logout option, just delete the application from the watch and loose the access & refresh tokens. |
|  4.5 | Products must follow Google OAuth guidelines for doing Google account linking.                                                                                                                                                                                                                                                                    | Yes       | This process could be streamlined if Garmin's built-in [`makeOAuthRequest`](https://developer.garmin.com/connect-iq/api-docs/Toybox/Communications.html#makeOAuthRequest-instance_function) function used a supported browser instead of a system webview (we have emailed the development team at Garmin, but we have not heard back). |
|  4.6 | Products that do not have valid Terms of Service and a Privacy Policy shown to the end user as part of Google OAuth will be rejected.                                                                                                                                                                                                             | Not yet   | Take the application as-is for free or lump it. The application does not retain any information. We can't vouch for Google's services that we use, see their T&Cs and privacy notice. |
|  4.7 | Google provides the ability for a user to revoke SDM API access. Products must handle this revoked authorization by reverting to a disconnected state and removing all user data.                                                                                                                                                                 | Yes       | Once access and refresh tokens fail, the full OAuth must be completed. If SDM API is revoked by the user, OAuth will fail. Used or failed tokens are deleted. There's nothing else we for the application to delete. |
|  4.8 | Products must include a link to Google's Partner Connections Manager to allow users to manage structures and device data access.                                                                                                                                                                                                                  | Yes       | Link to [Google Partner Connections Manager](https://nestservices.google.com/partnerconnections) provided in [auth.html](../auth.html) on completion of the initial part of the OAuth flow. This is also provided on the proposed Garmin IQ Application page (once published). The watch application cannot meaningfully provide this! |
|  4.9 | Products may be deactivated for various operational reasons. When a product is inactive, it will become unusable. Products that do not provide support for an inactive product (for example, proper user error messaging) will be rejected.                                                                                                       | Yes       | As a minimum the API error is printed to the watch screen via an ErrorView class. |
| 4.10 | Products that force users to reauthorize, after authorization has already been established, will be rejected.                                                                                                                                                                                                                                     | Yes       |         |
| 4.11 | Developer must place a "Limited Use" snippet on their project's homepage or on a page one click away from the homepage calling out the app's compliance with the Google API Services User Data Policy, including the Limited Use requirements. The snippet must be visible to all users and must be under 500 characters.                         | Yes       | ["Limited Use" snippet](index.md#limited-use). |

#### 5. Structures/Homes

|   ID | Requirement                                                                                                                                                | Compliant | Comment |
|-----:|------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------:|---------|
|  5.1 | Products that do not accommodate the possibility of multiple homes will be rejected.                                                                       | Yes       | Currently a single device can be selected from any structure or room. There are plans to allow swapping of the device to be controlled. |
|  5.2 | Products that do not provide a user a way to select the appropriate home for linking (for example, a structure picker) will be rejected.                   | Yes       | A single list of all thermostats over all owned structures. |
|  5.3 | Products that do not reflect home data updates (for example, home names or addition/subtraction of homes) within seconds after the update may be rejected. | No        | Its a watch application that is only briefly viewed. This is totally disproportionate to the use case and hence inappropriate. The the device ID can no longer be found it is deleted and the user prompted to select a different one on next update. No structure information is represented after device selection. |
|  5.4 | Products that cannot support multiple homes, each containing multiple devices of the same or different types, will be rejected.                            | Yes       |         |
|  5.5 | Products that cannot support empty homes (structures) or a combination of empty and non-empty homes will be rejected.                                      | Yes       |         |

#### 6. Google Nest Thermostats

|   ID | Requirement                                                                                                                                                                     | Compliant | Comment |
|-----:|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------:|---------|
|  6.1 | Products that instruct the user to turn off sensors and learning features of the Google Nest Thermostat will be rejected.                                                       | Yes       |         |
|  6.2 | Products that trigger thermostat updates without user interaction (for example, triggers and rules) and do not provide an indicator of any action that failed will be rejected. | Yes       | No automation. |
|  6.3 | Products that do not maintain temperatures, setpoints and ambient, in sync with the actual device temperatures, within seconds, may be rejected.                                | No        | Unrealistic for a Garmin IQ Watch application. The sandbox API [limits thermostat status checks to 5 QPM](https://developers.google.com/nest/device-access/project/limits), so polling the SDM API gives an error message in the sandbox when testing. There is an events PubSub mechanism that could potentially be used, calling [`makeWebRequest`](https://developer.garmin.com/connect-iq/api-docs/Toybox/Communications.html#makeWebRequest-instance_function) more frequently, but the SDK is currently deficient in two ways. Firstly the PubSub sends out based64 encoded data as the message part of the event. The Garmin IQ Monkey C API code does not include a base64 decode function. Secondly the base63 decoded message is then in JSON format. Whilst the [`makeWebRequest`](https://developer.garmin.com/connect-iq/api-docs/Toybox/Communications.html#makeWebRequest-instance_function) method can manage the JSON to [`Lang.Dictionary`](https://developer.garmin.com/connect-iq/api-docs/Toybox/Lang/Dictionary.html) conversion, those JSON functions are not made available in the API to be called on strings outside of [`makeWebRequest`](https://developer.garmin.com/connect-iq/api-docs/Toybox/Communications.html#makeWebRequest-instance_function), and hence the decoded JSON cannot immediately be parsed. Therefore two missing library functions/methods/classes need to be created to handle base64 decoding and JSON parsing before the PubSub API can be used to "within seconds" updates. Instead we provide a manual refresh button to tap which includes prevention of refresh within 10 seconds to mitigate the 5 QPM rate limit. |
|  6.4 | Products that do not handle multiple thermostats in one or multiple structures may be rejected.                                                                                 | Yes       |         |
|  6.5 | Products that do not update when thermostat data updates will be rejected.                                                                                                      | Yes       | Manual refresh button provided. |
|  6.6 | Products that do not update upon thermostat addition/removal will be rejected.                                                                                                  | Yes       | Error message then device reselection. As this is not an "always on" application, but a "fleeting glance" one, structure changes are managed by re-entering the application to refresh. |
|  6.7 | Products that do not support all possible thermostat modes, for example Heat, Cool, Heat-Cool, Off, Eco, may be rejected.                                                       | Yes       |         |
|  6.8 | Products that do not support Heat-Cool limits properly (3 degrees apart in F and 1.5 in C) will be rejected.                                                                    | Yes       |         |
|  6.9 | Products that do not support temperature limits correctly (50-90 F and 9-32 C) will be rejected.                                                                                | Yes       | 48-90 F supported since that's the range on our Nest product. |
| 6.10 | Products that provide fan functionality and do not support starting and stopping of a fan timer will be rejected.                                                               | Yes       | No support for fans |
| 6.11 | Products that do not display and update, within seconds of updates, correct thermostat locations and names will be rejected.                                                    | Yes       | No names displayed except when selecting one. As this is not an "always on" application, but a "fleeting glance" one, structure changes are managed by re-entering the application to refresh. |
| 6.12 | Products that do not support C to F transitions by reading and updating or writing the units back to Google Nest may be rejected.                                               | Yes       |         |

#### 7. Google Nest Cameras, Google Nest Doorbells, and Nest Hub Max

Does not apply.
